<!DOCTYPE html>
    <html>
    <header>
    <link rel="stylesheet" type="text/css" href="css/page.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    </header>

    <body>

<div class="main">
    <h1>Watch your favorite shows, instantly.</h1>
    <input type="text" class="form-control" id="search" placeholder="Search the collection"> 
</div>
<div class="normal-text">
    <select id="showList" onchange="loadSeasons(this.value,'_top')">
        <option value=''>Select a Popular Show:</option>
    </select>
     <select id="seasonList" onchange="loadEpisodes(this)">
    </select>
    <select id="episodeList" onchange="loadVideo(this)">
        <option value=''>Select Episode:</option>
    </select>
</div>

<div id="choice" class="normal-text"></div>
<div id="video-links"> </div>

<div class="supporting container">
    <div id="showbox" class="row"></div>
</div>

    <script>

    /* Initialization */
    $("#episodeList").hide();
    $("#seasonList").hide();
    var listOfShows = ["Selection"];
    var numSeasons = 0;
    var numEpisodes = 0;
    var selectedShowName = "";
    var selectedSeasonNum = 1;
    var yqlLink = "";

    yqlLink = "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%20%3D%20%22http%3A%2F%2Fwww.imdb.com%2Fsearch%2Ftitle%3Ftitle_type%3Dtv_series%22%20and%20xpath%20%3D%20%22%2F%2Ftd%5B%40class%3D'image'%5D%2Fa%2Fimg%22&diagnostics=true"; 


    /* Fetching the top 50 tv shows */
    $.ajax({
      type: 'GET', 
      url: yqlLink, 
      dataType: 'html',
      success: function(data) { 
        $('#showbox').append($(data).find('img'));
        $("img").each(function(index,value){
            var title = $(this).attr('title').split('(')[0].trim().replace(/[^a-zA-Z0-9 ]/g, "").replace(/ /g,'-').replace(/039/g,"").toLowerCase();
            var img_src = $(this).attr('src').split('_')[0] + "300.jpg";
            var imgStr = "<div class=\"col-sm-3 thumbnail\"><div id='" + title + "' onclick=\"loadSeasons(this.id)\"><img src=\"" + img_src + "\" widht='280px' height='300px'></div></div>";
            value.outerHTML = imgStr;
            var optionStr = "<option value=\"" + title + "\">" + $(this).attr('title').split('(')[0] + "</option>";
            $('#showList').append(optionStr);
        });
      }
    });

    // Load the seasons for the selected show
    function loadSeasons(val){
        window.location.href="#search";
        $("#search").val(val.replace('-',' '));
        document.getElementById("choice").innerHTML = val + " has ";
        document.getElementById("seasonList").innerHTML = "<option>Select Season</option>";
        $("#episodeList").hide();
        $("#seasonList").show();
        selectedShowName = val;
        yqlLink =  "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%20%3D%20%22http%3A%2F%2Fputlocker.is%2Fwatch-" + selectedShowName + "-tvshow-online-free-putlocker.html%22%20and%20xpath%3D%22(%2F%2Fdiv%5B%40class%3D'content-box'%5D%2Fh2%5Bfollowing-sibling%3A%3A*%5B1%5D%2Fself%3A%3Atable%5D%2Fa%2Fstrong)%5Blast()%5D%22&diagnostics=true";
        $.ajax({
            type: 'GET', 
            url: yqlLink, 
            dataType: 'html',
            success: function(data) { 
                numSeasons = parseInt($(data).find('strong').text().replace("Season ",''));
                $("#choice").append(numSeasons + " seasons.");
                for(var i = numSeasons; i > 0; i--){
                    var optionStr = "<option value=\"" + i + "\"> Season " + i + "</option>";
                    $('#seasonList').append(optionStr);
                }
            }
        });
    }

    function loadEpisodes(sel){
        $('#episodeList').show();
        document.getElementById("choice").innerHTML = "";
        document.getElementById("episodeList").innerHTML = "<option>Select Episode</option>";
        selectedSeasonNum = sel.value;
        yqlLink = "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%20%3D%20%22http%3A%2F%2Fputlocker.is%2Fwatch-" + selectedShowName + "-tvshow-season-" + selectedSeasonNum +"-online-free-putlocker.html%22%20and%20xpath%3D%22(%2F%2Ftd%5B%40class%3D'entry'%5D%2Fa)%5Blast()%5D%2Fstrong%22%20&diagnostics=true";
        $.ajax({
            type: 'GET', 
            url: yqlLink, 
            dataType: 'html',
            success: function(data) { 
                numEpisodes = parseInt($(data).find('strong').text().replace("Episode ",''));
                $("#choice").append("Season " + selectedSeasonNum + " has " + numEpisodes + " episodes.");
                for(var i = 1; i <= numEpisodes; i++){
                    var optionStr = "<option value=\"" + i + "\"> Episode " + i + "</option>";
                    $('#episodeList').append(optionStr);
                }
            }
        });
    }

    function loadVideo(sel){
        document.getElementById("video-links").innerHTML = "";
        var putlocker_url = "http://putlocker.is/watch-" + selectedShowName + "-tvshow-season-" + selectedSeasonNum + "-episode-" + sel.value+ "-online-free-putlocker.html";
        var url = "https://mighty-wildwood-6680.herokuapp.com/?url=http://putlocker.is/watch-" + selectedShowName + "-tvshow-season-" + selectedSeasonNum + "-episode-" + sel.value+ "-online-free-putlocker.html";
        document.getElementById("choice").innerHTML = "<a href=\"" + putlocker_url + "\">Putlocker link</a>";
        window.open(url);
        //window.location.href = url;
        yqlLink = "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%20%3D%20%22https%3A%2F%2Fmighty-wildwood-6680.herokuapp.com%2F%3Furl%3Dhttp%3A%2F%2Fputlocker.is%2Fwatch-" + selectedShowName + "-tvshow-season-" + selectedSeasonNum + "-episode-" + sel.value + "-online-free-putlocker.html%22%20and%20xpath%3D%22%2F%2Fiframe%22&diagnostics=true";
        $.ajax({
            type: 'GET', 
            url: yqlLink, 
            dataType: 'html',
            success: function(data) { 
                $("#video-links").append($(data).find('results'));
            }
        });
    }

    </script>

    <script> 
    $("#search").keyup(function(event){
        if(event.keyCode == 13){
            loadSeasons(document.getElementById("search").value.replace(/[^a-zA-Z0-9 ]/g, "").replace(/ /g,'-').replace(/039/g,"").toLowerCase());
        }
    });
    </script>
    </body>
    </html>
